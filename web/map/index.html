<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css"
      integrity="sha384-dpuaG1suU0eT09tx5plTaGMLBsfDLzUCCUXOY2j/LSvXYuG6Bqs43ALlhIqAJVRb"
      crossorigin="anonymous"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Leaflet.markercluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />

    <!-- Custom CSS -->
    <style>
      #map {
        height: 66vh;
        border-top: 1px solid var(--bs-gray);
        border-bottom: 1px solid var(--bs-gray);
      }
      #spinner {
        text-align: right;
      }
    </style>

    <title>Map</title>
  </head>
  <body>
    <h1>Map</h1>

    <div id="map"></div>

    <!-- A spinner that indicates that we are loading data. -->
    <div id="spinner" hidden>
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Loading data...</span>
      </div>
    </div>

    <!-- Bootstrap and Popper JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Leaflet.markercluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- PapaParse JS -->
    <script src="https://unpkg.com/papaparse@5.5.2/papaparse.min.js"></script>

    <!-- Custom JS -->
    <script>
      (async function () {
        /**
         * Uses PapaParse to both fetch, and parse, a CSV file.
         * If fetching and parsing are successful, this function
         * returns a Promise that resolves to the parsed data.
         * Otherwise, this function returns a Promise that resolves
         * to an error descriptor.
         *
         * @param fileUrl URL of the CSV file
         * @return {Promise}
         *
         * Reference: https://www.papaparse.com/docs#csv-to-json
         */
        function fetchAndParseCsvFile(fileUrl) {
          return new Promise((resolve, reject) => {
            Papa.parse(fileUrl, {
              download: true,
              header: true, // produces array of objects, instead of array of arrays
              skipEmptyLines: true,
              complete: (results, file) => {
                console.debug("Fetching and parsing complete.", results, file);
                resolve(results.data);
              },
              error: (error, file) => {
                console.error("Fetch or parsing failed.", error, file);
                reject(error);
              },
            });
          });
        }

        /**
         * Draws a map on the HTML element having the specified ID.
         *
         * Reference: https://leafletjs.com/examples/quick-start/
         */
        function initializeMap(elementId) {
          // Create a map.
          const map = L.map(elementId, {
            zoomAnimation: false,
          })
            .fitWorld()
            .zoomIn();

          map.on("resize", () => {
            map.fitWorld({ reset: true }).zoomIn();
          });

          // Add a tile layer.
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          }).addTo(map);

          return map;
        }

        /**
         * Makes the HTML element having the specified ID, visible.
         *
         * @param elementId
         */
        function showSpinner(elementId) {
          document.getElementById(elementId).removeAttribute("hidden");
        }

        /**
         * Hides the HTML element having the specified ID.
         *
         * @param elementId
         */
        function hideSpinner(elementId) {
          document.getElementById(elementId).setAttribute("hidden", "hidden");
        }

        showSpinner("spinner");

        const map = initializeMap("map");
        const markerClusterGroup = L.markerClusterGroup();

        // Fetch the NMDC CSV file and create a marker for each row.
        const nmdcObjs = await fetchAndParseCsvFile(
          "https://raw.githubusercontent.com/ber-data/bertron/refs/heads/main/nmdc/nmdc_biosample_geo_coordinates.csv",
        );
        nmdcObjs.forEach((obj) => {
          const latLon = [
            parseFloat(obj["latitude"]),
            parseFloat(obj["longitude"]),
          ];
          const popupStr = `NMDC Biosample<br/>${obj["biosample_id"]}`;
          const marker = L.marker(latLon).bindPopup(popupStr);
          markerClusterGroup.addLayer(marker);
        });
        console.debug(
          `Created markers for ${nmdcObjs.length} NMDC biosamples.`,
        );

        // Fetch the ESS-Dive CSV file and create a marker for each row.
        const essDiveObjs = await fetchAndParseCsvFile(
          "https://raw.githubusercontent.com/ber-data/bertron/refs/heads/main/ess-dive/ess_dive_packages.csv",
        );
        essDiveObjs.forEach((obj) => {
          const latLon = [
            parseFloat(obj["centroid_latitude"]),
            parseFloat(obj["centroid_longitude"]),
          ];
          const popupStr = `ESS-Dive Package<br/>${obj["package_id"]}`;
          const marker = L.marker(latLon).bindPopup(popupStr);
          markerClusterGroup.addLayer(marker);
        });
        console.debug(
          `Created markers for ${essDiveObjs.length} ESS-Dive packages.`,
        );

        // Fetch the JGI GOLD Biosample CSV file and create a marker for each row.
        const jgiGoldBsmObjs = await fetchAndParseCsvFile(
          "https://raw.githubusercontent.com/ber-data/bertron/refs/heads/main/jgi/jgi_gold_biosample_geo.csv",
        );
        jgiGoldBsmObjs.forEach((obj) => {
          const latLon = [
            parseFloat(obj["latitude"]),
            parseFloat(obj["longitude"]),
          ];
          const popupStr = `JGI GOLD Biosample<br/>${obj["gold_id"]}`;
          const marker = L.marker(latLon).bindPopup(popupStr);
          markerClusterGroup.addLayer(marker);
        });
        console.debug(
          `Created markers for ${jgiGoldBsmObjs.length} JGI GOLD biosamples.`,
        );

        // Fetch the JGI GOLD Organism CSV file and create a marker for each row.
        const jgiGoldOrgObjs = await fetchAndParseCsvFile(
          "https://raw.githubusercontent.com/ber-data/bertron/refs/heads/main/jgi/jgi_gold_organism_geo.csv",
        );
        jgiGoldOrgObjs.forEach((obj) => {
          const latLon = [
            parseFloat(obj["latitude"]),
            parseFloat(obj["longitude"]),
          ];
          const popupStr = `JGI GOLD Organism<br/>${obj["gold_id"]}`;
          const marker = L.marker(latLon).bindPopup(popupStr);
          markerClusterGroup.addLayer(marker);
        });
        console.debug(
          `Created markers for ${jgiGoldOrgObjs.length} JGI GOLD organisms.`,
        );

        // Fetch the EMSL JSON file and create a marker for each element of its top-level array.
        const response = await fetch(
          "https://raw.githubusercontent.com/ber-data/bertron/refs/heads/main/emsl/latlon_project_ids.json",
        );
        const emslObjs = await response.json();
        emslObjs.forEach((obj) => {
          const latLon = [
            parseFloat(obj["latitude"]),
            parseFloat(obj["longitude"]),
          ];
          const popupStr = `EMSL<br/>Proposal ${obj["proposal_id"]}, Sampling set ${obj["sampling_set"]}`;
          const marker = L.marker(latLon).bindPopup(popupStr);
          markerClusterGroup.addLayer(marker);
        });
        console.debug(`Created markers for ${emslObjs.length} EMSL objects.`);

        map.addLayer(markerClusterGroup);

        hideSpinner("spinner");
      })();
    </script>
  </body>
</html>
